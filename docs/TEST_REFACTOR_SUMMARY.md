# æµ‹è¯•ä»£ç é‡æ„æ€»ç»“

## ä¿®æ”¹æ¦‚è¿°

æœ¬æ¬¡é‡æ„å½»åº•ç§»é™¤äº† `tests/test_crawl_cve.py` ä¸­çš„æ‰€æœ‰å‡æ•°æ®å’Œæ¨¡æ‹Ÿæµ‹è¯•ï¼Œæ”¹ä¸ºåŸºäºçœŸå®Gitä»“åº“å’Œç¼“å­˜æ•°æ®åº“çš„æµ‹è¯•æ¡†æ¶ã€‚

## ä¸»è¦å˜æ›´

### 1. ç§»é™¤çš„å‡æ•°æ®

#### ä¹‹å‰çš„é—®é¢˜
```python
# æ—§ä»£ç  - æ¨¡æ‹Ÿæœç´¢ç»“æœ
print(f"  ğŸ’¡ æ¨¡æ‹Ÿæœç´¢ç»“æœï¼ˆå®é™…ä½¿ç”¨éœ€è¦é…ç½®GitRepoManagerï¼‰:")
print()
print(f"  å‡è®¾æ‰¾åˆ°ä»¥ä¸‹å€™é€‰commits:")
print(f"    1. abc123def456 - [backport] {subject}")
print(f"       ç½®ä¿¡åº¦: 95% (subjectå®Œå…¨åŒ¹é…)")
print(f"    2. def456ghi789 - Similar fix for the same issue")
print(f"       ç½®ä¿¡åº¦: 75% (ä¿®æ”¹ç›¸åŒæ–‡ä»¶)")
```

**é—®é¢˜**: 
- æ˜æ˜æ²¡æœ‰çœŸå®çš„commitæ•°æ®ï¼Œå´æ˜¾ç¤º"æ‰¾åˆ°åŒ¹é…"
- è¯¯å¯¼ç”¨æˆ·ä»¥ä¸ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- æ— æ³•éªŒè¯å®é™…çš„æœç´¢èƒ½åŠ›

#### ä¿®æ”¹å
```python
# æ–°ä»£ç  - çœŸå®æœç´¢
if not target_repo_version:
    print(f"  âŒ é”™è¯¯: æœªé…ç½®ç›®æ ‡ä»“åº“")
    print(f"  è¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤:")
    print(f"    1. å¤åˆ¶ config.example.yaml ä¸º config.yaml")
    print(f"    2. åœ¨ config.yaml ä¸­é…ç½®ä»“åº“è·¯å¾„å’Œåˆ†æ”¯")
    # ... åªæ˜¾ç¤ºæœç´¢ç­–ç•¥ï¼Œä¸æ˜¾ç¤ºå‡ç»“æœ
```

### 2. æ–°å¢ç¼“å­˜ç®¡ç†åŠŸèƒ½

#### æ–°å¢å‡½æ•°

```python
def check_cache_exists(repo_version: str = None) -> tuple:
    """
    æ£€æŸ¥ç¼“å­˜æ•°æ®åº“æ˜¯å¦å­˜åœ¨ä»¥åŠæ˜¯å¦æœ‰æ•°æ®
    
    Returns:
        (cache_exists, has_data, commit_count)
    """
```

```python
def build_cache_for_repo(repo_version: str, max_commits: int = 10000):
    """
    ä¸ºæŒ‡å®šä»“åº“æ„å»ºç¼“å­˜
    
    Args:
        repo_version: ä»“åº“ç‰ˆæœ¬åç§°
        max_commits: æœ€å¤§ç¼“å­˜çš„commitæ•°é‡
    """
```

### 3. æ”¹è¿›çš„æµ‹è¯•æµç¨‹

#### test_search_introduced_commit å‡½æ•°

**ä¹‹å‰**: ç›´æ¥æ˜¾ç¤ºå‡æ•°æ®

**ä¿®æ”¹å**:
1. æ£€æŸ¥æ˜¯å¦é…ç½®äº†ä»“åº“
2. æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨
3. å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œè¯¢é—®æ˜¯å¦æ„å»º
4. æ‰§è¡ŒçœŸå®çš„æœç´¢
5. æ˜¾ç¤ºçœŸå®çš„æœç´¢ç»“æœå’Œç›¸ä¼¼åº¦

```python
# æ£€æŸ¥ç¼“å­˜
cache_exists, has_data, commit_count = check_cache_exists(target_repo_version)

if not cache_exists or not has_data:
    print(f"  âš ï¸  è­¦å‘Š: ç¼“å­˜æ•°æ®åº“ä¸å­˜åœ¨æˆ–æ— æ•°æ®")
    response = input(f"  æ˜¯å¦ç°åœ¨ä¸º {target_repo_version} æ„å»ºç¼“å­˜? (y/n): ")
    if response == 'y':
        build_cache_for_repo(target_repo_version, max_commits)
```

#### test_check_fix_merged å‡½æ•°

åŒæ ·çš„æ”¹è¿›ï¼š
- ç§»é™¤æ¨¡æ‹Ÿåœºæ™¯A/Bçš„å‡æ•°æ®
- æ·»åŠ ç¼“å­˜æ£€æŸ¥
- æ‰§è¡ŒçœŸå®æœç´¢
- æä¾›è¯¦ç»†çš„è°ƒè¯•å»ºè®®

### 4. æ–°å¢å‘½ä»¤

#### build-cache å‘½ä»¤

```bash
python test_crawl_cve.py build-cache <repo_version> [max_commits]
```

ç”¨é€”ï¼š
- ä¸ºæŒ‡å®šä»“åº“æ„å»ºcommitç¼“å­˜
- æé«˜åç»­æœç´¢æ•ˆç‡
- é¦–æ¬¡ä½¿ç”¨å‰å¿…é¡»æ‰§è¡Œ

ç¤ºä¾‹ï¼š
```bash
python test_crawl_cve.py build-cache 5.10-hulk 10000
```

#### æ”¹è¿›çš„ repos å‘½ä»¤

æ–°å¢æ˜¾ç¤ºï¼š
- ç¼“å­˜çŠ¶æ€
- å·²ç¼“å­˜çš„commitæ•°é‡
- æ„å»ºç¼“å­˜çš„å»ºè®®å‘½ä»¤

è¾“å‡ºç¤ºä¾‹ï¼š
```
é…ç½®çš„ä»“åº“:
  - 5.10-hulk
      è·¯å¾„: /data/zhangmh/kernel
      åˆ†æ”¯: 5.10.0-60.18.0.50.oe2203
      è¯´æ˜: åä¸º5.10å†…æ ¸ç»´æŠ¤ç‰ˆæœ¬
      ç¼“å­˜: âœ… å·²ç¼“å­˜ 10000 ä¸ªcommits
```

### 5. æ”¹è¿›çš„é”™è¯¯å¤„ç†

#### çœŸå®çš„æœç´¢ç»“æœ

```python
# ç­–ç•¥1: ç²¾ç¡®IDåŒ¹é…
exact_match = manager.find_commit_by_id(commit_id, repo_version)

if exact_match:
    print(f"  âœ… æ‰¾åˆ°ç²¾ç¡®åŒ¹é…:")
    print(f"     Commit: {exact_match['commit_id'][:12]}")
    print(f"     Subject: {exact_match['subject']}")
else:
    print(f"  æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…çš„commit ID")
```

#### è¯¦ç»†çš„ç›¸ä¼¼åº¦æ˜¾ç¤º

```python
# ç­–ç•¥2: Subjectæ¨¡ç³ŠåŒ¹é…
for i, c in enumerate(candidates[:5], 1):
    similarity = calculate_subject_similarity(subject, c.subject)
    print(f"     {i}. {c.commit_id[:12]} - {c.subject[:60]}...")
    print(f"        ç›¸ä¼¼åº¦: {similarity:.1%}")
```

#### æ˜ç¡®çš„å¤±è´¥æç¤º

```python
print(f"\n  âŒ æœªæ‰¾åˆ°åŒ¹é…çš„commit")
print(f"  å»ºè®®:")
print(f"    1. æ£€æŸ¥è¯¥commitæ˜¯å¦çœŸçš„å­˜åœ¨äºç›®æ ‡ä»“åº“")
print(f"    2. å°è¯•æ‰‹åŠ¨ä½¿ç”¨gitå‘½ä»¤æœç´¢")
print(f"    3. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ä¸åŒçš„commit messageæ ¼å¼")
```

### 6. å¯åŠ¨ä¿¡æ¯æ”¹è¿›

#### æ˜¾ç¤ºç¼“å­˜çŠ¶æ€

```python
# æ£€æŸ¥ç¼“å­˜çŠ¶æ€
cache_exists, has_data, commit_count = check_cache_exists(repo_name)
if has_data:
    print(f"      ç¼“å­˜: âœ… å·²ç¼“å­˜ {commit_count} ä¸ªcommits")
else:
    print(f"      ç¼“å­˜: âš ï¸  æœªæ„å»º (å»ºè®®æ‰§è¡Œ: python test_crawl_cve.py build-cache {repo_name})")
    has_uncached = True
```

#### å‹å¥½çš„æç¤ºä¿¡æ¯

```python
if has_uncached:
    print("ğŸ’¡ æç¤º: é¦–æ¬¡ä½¿ç”¨å»ºè®®å…ˆæ„å»ºç¼“å­˜ï¼Œå¯å¤§å¹…æé«˜æœç´¢æ•ˆç‡")
    print("   å‘½ä»¤: python test_crawl_cve.py build-cache <repo_name> [max_commits]")
```

## ä½¿ç”¨æµç¨‹å¯¹æ¯”

### æ—§æµç¨‹ï¼ˆæœ‰å‡æ•°æ®ï¼‰

```bash
# 1. ç›´æ¥è¿è¡Œæµ‹è¯•
python test_crawl_cve.py search_introduced abc123

# è¾“å‡ºï¼š
# ğŸ’¡ æ¨¡æ‹Ÿæœç´¢ç»“æœï¼ˆå®é™…ä½¿ç”¨éœ€è¦é…ç½®GitRepoManagerï¼‰:
# å‡è®¾æ‰¾åˆ°ä»¥ä¸‹å€™é€‰commits:
#   1. abc123def456 - [backport] xxx
#      ç½®ä¿¡åº¦: 95% (subjectå®Œå…¨åŒ¹é…)  â† è¿™æ˜¯å‡çš„ï¼
```

### æ–°æµç¨‹ï¼ˆçœŸå®æ•°æ®ï¼‰

```bash
# 1. é…ç½®ä»“åº“
cp config.example.yaml config.yaml
vim config.yaml

# 2. æŸ¥çœ‹é…ç½®å’Œç¼“å­˜çŠ¶æ€
python test_crawl_cve.py repos

# 3. æ„å»ºç¼“å­˜ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
python test_crawl_cve.py build-cache 5.10-hulk 10000

# 4. è¿è¡Œæµ‹è¯•ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰
python test_crawl_cve.py search_introduced abc123 5.10-hulk

# è¾“å‡ºï¼š
# ğŸ” ç­–ç•¥1: ç²¾ç¡®commit IDåŒ¹é…...
# âœ… æ‰¾åˆ°ç²¾ç¡®åŒ¹é…:  â† è¿™æ˜¯çœŸå®çš„æœç´¢ç»“æœï¼
#    Commit: abc123def456
#    Subject: [backport] xxx
```

## å…³é”®æ”¹è¿›ç‚¹

### 1. å‡†ç¡®æ€§
- âœ… ç§»é™¤æ‰€æœ‰å‡æ•°æ®
- âœ… åŸºäºçœŸå®Gitä»“åº“
- âœ… çœŸå®çš„æœç´¢ç»“æœ
- âœ… çœŸå®çš„ç›¸ä¼¼åº¦è®¡ç®—

### 2. å¯é æ€§
- âœ… éœ€è¦å…ˆæ„å»ºç¼“å­˜
- âœ… æ£€æŸ¥ä»“åº“è·¯å¾„æ˜¯å¦å­˜åœ¨
- âœ… è¯¦ç»†çš„é”™è¯¯å¤„ç†
- âœ… æ˜ç¡®çš„å¤±è´¥åŸå› 

### 3. å¯ç”¨æ€§
- âœ… å‹å¥½çš„æç¤ºä¿¡æ¯
- âœ… äº¤äº’å¼ç¼“å­˜æ„å»º
- âœ… è¯¦ç»†çš„æœç´¢è¿‡ç¨‹
- âœ… æ¸…æ™°çš„å»ºè®®å’Œä¸‹ä¸€æ­¥æ“ä½œ

### 4. é€æ˜æ€§
- âœ… æ˜¾ç¤ºæœç´¢ç­–ç•¥
- âœ… æ˜¾ç¤ºç›¸ä¼¼åº¦åˆ†æ•°
- âœ… æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
- âœ… æ˜¾ç¤ºcommitæ•°é‡

## æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **tests/test_crawl_cve.py**
   - æ–°å¢å‡½æ•°ï¼š`check_cache_exists()`, `build_cache_for_repo()`
   - é‡æ„å‡½æ•°ï¼š`test_search_introduced_commit()`, `test_check_fix_merged()`
   - ç§»é™¤ï¼šæ‰€æœ‰æ¨¡æ‹Ÿæœç´¢ç»“æœçš„ä»£ç 
   - æ–°å¢å‘½ä»¤ï¼š`build-cache`
   - æ”¹è¿›å‘½ä»¤ï¼š`repos`
   - æ”¹è¿›ï¼šå¯åŠ¨ä¿¡æ¯æ˜¾ç¤º

### æ–°å¢çš„æ–‡æ¡£

1. **docs/TESTING_CACHE_GUIDE.md**
   - æµ‹è¯•å’Œç¼“å­˜ä½¿ç”¨çš„å®Œæ•´æŒ‡å—
   - åŒ…å«æ‰€æœ‰å‘½ä»¤è¯´æ˜
   - å¸¸è§é—®é¢˜è§£ç­”
   - ç¤ºä¾‹å·¥ä½œæµ

2. **docs/TEST_REFACTOR_SUMMARY.md** (æœ¬æ–‡ä»¶)
   - é‡æ„çš„è¯¦ç»†è¯´æ˜
   - å˜æ›´å¯¹æ¯”
   - ä½¿ç”¨æµç¨‹å¯¹æ¯”

## å‘åå…¼å®¹æ€§

### ä¿æŒå…¼å®¹çš„éƒ¨åˆ†

- âœ… æ‰€æœ‰åŸæœ‰å‘½ä»¤ä»ç„¶å¯ç”¨
- âœ… å‘½ä»¤å‚æ•°æ ¼å¼ä¸å˜
- âœ… é…ç½®æ–‡ä»¶æ ¼å¼ä¸å˜
- âœ… è¾“å‡ºç»“æœæ ¼å¼åŸºæœ¬ä¸€è‡´

### éœ€è¦æ³¨æ„çš„å˜åŒ–

- âš ï¸  é¦–æ¬¡ä½¿ç”¨éœ€è¦æ„å»ºç¼“å­˜
- âš ï¸  æ²¡æœ‰é…ç½®æ—¶ä¸å†æ˜¾ç¤ºå‡æ•°æ®
- âš ï¸  éœ€è¦çœŸå®çš„ä»“åº“è·¯å¾„
- âš ï¸  æœç´¢ç»“æœåŸºäºçœŸå®æ•°æ®ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰

## æµ‹è¯•å»ºè®®

### é¦–æ¬¡ä½¿ç”¨

```bash
# 1. å…‹éš†æˆ–å‡†å¤‡kernelä»“åº“
git clone <your-kernel-repo> /path/to/kernel

# 2. é…ç½®
cp config.example.yaml config.yaml
# ç¼–è¾‘ config.yamlï¼Œå¡«å†™ä»“åº“è·¯å¾„

# 3. éªŒè¯é…ç½®
python test_crawl_cve.py repos

# 4. æ„å»ºç¼“å­˜
python test_crawl_cve.py build-cache 5.10-hulk 10000

# 5. è¿è¡Œæµ‹è¯•
python test_crawl_cve.py CVE-2024-26633
```

### æ—¥å¸¸ä½¿ç”¨

```bash
# æŸ¥æ‰¾å¼•å…¥commit
python test_crawl_cve.py search_introduced <commit_id>

# æ£€æŸ¥ä¿®å¤æ˜¯å¦åˆå…¥
python test_crawl_cve.py check_fix <commit_id> <repo> <cve_id>

# æ›´æ–°ç¼“å­˜ï¼ˆå½“ä»“åº“æœ‰æ–°commitsæ—¶ï¼‰
rm commit_cache.db
python test_crawl_cve.py build-cache 5.10-hulk 15000
```

## æ€§èƒ½å¯¹æ¯”

### ä½¿ç”¨ç¼“å­˜

- ç²¾ç¡®IDåŒ¹é…ï¼š< 0.1ç§’
- Subjectæœç´¢ï¼š< 1ç§’
- æ–‡ä»¶æœç´¢ï¼š< 2ç§’

### ä¸ä½¿ç”¨ç¼“å­˜

- ç²¾ç¡®IDåŒ¹é…ï¼š5-10ç§’
- Subjectæœç´¢ï¼š30-60ç§’
- æ–‡ä»¶æœç´¢ï¼š1-3åˆ†é’Ÿ

**ç»“è®º**: æ„å»ºç¼“å­˜å¯ä»¥å°†æœç´¢é€Ÿåº¦æå‡ 10-100 å€ï¼

## æ€»ç»“

æœ¬æ¬¡é‡æ„çš„æ ¸å¿ƒç›®æ ‡ï¼š**ç§»é™¤å‡æ•°æ®ï¼Œç¡®ä¿æµ‹è¯•çš„çœŸå®æ€§å’Œå‡†ç¡®æ€§**

### ä¸»è¦æˆæœ

1. âœ… å®Œå…¨ç§»é™¤å‡æ•°æ®å’Œæ¨¡æ‹Ÿç»“æœ
2. âœ… æ·»åŠ ç¼“å­˜ç®¡ç†åŠŸèƒ½
3. âœ… æ”¹è¿›é”™è¯¯å¤„ç†å’Œæç¤º
4. âœ… æä¾›å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£
5. âœ… ä¿æŒå‘åå…¼å®¹

### ç”¨æˆ·ä½“éªŒæ”¹è¿›

- **ä¹‹å‰**: "æ‰¾åˆ°åŒ¹é…"ä½†æ˜¯å‡çš„ â†’ è¯¯å¯¼ç”¨æˆ·
- **ç°åœ¨**: è¦ä¹ˆçœŸçš„æ‰¾åˆ°ï¼Œè¦ä¹ˆæ˜ç¡®å‘ŠçŸ¥æœªæ‰¾åˆ° â†’ å‡†ç¡®å¯é 

### ä¸‹ä¸€æ­¥å»ºè®®

1. ä½¿ç”¨æ–°çš„æµ‹è¯•æ¡†æ¶è¿›è¡Œå®é™…æµ‹è¯•
2. æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼
3. æ”¶é›†åé¦ˆï¼ŒæŒç»­æ”¹è¿›æœç´¢ç­–ç•¥
4. è€ƒè™‘æ·»åŠ æ›´å¤šçš„æœç´¢ç­–ç•¥ï¼ˆå¦‚åŸºäºdiffç›¸ä¼¼åº¦ï¼‰

## ç›¸å…³æ–‡æ¡£

- [é…ç½®ä½¿ç”¨è¯´æ˜](CONFIG_USAGE.md)
- [æµ‹è¯•å’Œç¼“å­˜æŒ‡å—](TESTING_CACHE_GUIDE.md)
- [é¡¹ç›®ç»“æ„](../PROJECT_STRUCTURE.md)
